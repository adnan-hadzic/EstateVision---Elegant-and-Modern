<div class="container mt-4">
    <div class="alert alert-primary shadow-sm">
        <h4 class="alert-heading">Welcome back, <span id="dashUsername">User</span>! ðŸ‘‹</h4>
        <p class="mb-0">Here is what's happening with your estate journey today.</p>
    </div>

    <div class="row mt-4">
        <div class="col-md-4">
            <div class="card text-center shadow-sm p-3 mb-3">
                <i class="bi bi-heart text-danger display-4"></i>
                <h3 class="mt-2">0</h3>
                <p class="text-muted">Saved Properties</p>
                <button class="btn btn-outline-primary btn-sm">View List</button>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card text-center shadow-sm p-3 mb-3">
                <i class="bi bi-chat-dots text-success display-4"></i>
                <h3 class="mt-2">0</h3>
                <p class="text-muted">Active Inquiries</p>
                <button class="btn btn-outline-success btn-sm">Check Messages</button>
            </div>
        </div>

        <div class="col-md-4">
            <div id="adminCard" class="card text-center shadow p-3 mb-3 bg-light border-danger d-none">
                <i class="bi bi-shield-lock-fill text-danger display-4"></i>
                <h3 class="mt-2 text-danger">Admin</h3>
                <p class="text-muted">System Management</p>
                <button class="btn btn-danger btn-sm" onclick="window.location.hash='#admin'">Open Panel</button>
            </div>
            
            <div id="userCard" class="card text-center shadow-sm p-3 mb-3">
                <i class="bi bi-search text-primary display-4"></i>
                <h3 class="mt-2">Search</h3>
                <p class="text-muted">Find New Home</p>
                <button class="btn btn-primary btn-sm">Start Searching</button>
            </div>
        </div>
    </div>

    <div id="agentSection" class="mt-5 d-none">
        <div class="card shadow border-0">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-building-add me-2"></i>My Property Listings</h5>
                <button class="btn btn-light btn-sm fw-bold text-success" onclick="openAddPropertyModal()">
                    + List New Property
                </button>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th class="ps-4">Title</th>
                                <th>Location</th>
                                <th>Price</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="agentPropertiesList">
                            <tr><td colspan="5" class="text-center py-4 text-muted">You haven't listed any properties yet.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="addPropertyModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">List New Property</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="propertyForm">
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label class="form-label">Property Title</label>
                            <input type="text" class="form-control" id="propTitle" placeholder="e.g. Modern Apartment in Sarajevo" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Price (â‚¬)</label>
                            <input type="number" class="form-control" id="propPrice" placeholder="0" required>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Address / Location</label>
                        <input type="text" class="form-control" id="propAddress" placeholder="Full address" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="propDesc" rows="3"></textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Bedrooms</label>
                            <input type="number" class="form-control" id="propBeds" value="1">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Bathrooms</label>
                            <input type="number" class="form-control" id="propBaths" value="1">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Size (mÂ²)</label>
                            <input type="number" class="form-control" id="propSize" value="50">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="saveProperty()">Publish Listing</button>
            </div>
        </div>
    </div>
</div>

<script>A
    (function initDashboard(){
        const user = JSON.parse(localStorage.getItem('user'));
        
        if(user){
            document.getElementById('dashUsername').textContent = user.full_name || user.name;
            
            if(user.role === 'admin'){
                document.getElementById('adminCard').classList.remove('d-none');
                document.getElementById('userCard').classList.add('d-none');
            }

            if(user.role === 'agent'){
                document.getElementById('agentSection').classList.remove('d-none');
            }
        }
    })();

    let propModal;
    
    function openAddPropertyModal() {
        propModal = new bootstrap.Modal(document.getElementById('addPropertyModal'));
        propModal.show();
    }

    function saveProperty() {
        const user = JSON.parse(localStorage.getItem('user'));
        
        const propertyData = {
            title: document.getElementById('propTitle').value,
            price: document.getElementById('propPrice').value,
            location: document.getElementById('propAddress').value, 
            description: document.getElementById('propDesc').value,
            area: document.getElementById('propSize').value, 
            bedrooms: document.getElementById('propBeds').value,
            bathrooms: document.getElementById('propBaths').value,
            property_type: 'apartment', 
            agent_id: user.id || user.user_id 
        };

        if(!propertyData.title || !propertyData.price) {
            return alert("Title and Price are required!");
        }

        RestClient.post('properties', propertyData, function(response){
            alert("Success! Property added to database.");
            
            if(propModal) propModal.hide();
            document.getElementById('propertyForm').reset();
            
            location.reload();
            
        }, function(error){
            console.error("Error adding property:", error);
            alert("Error adding property. Check console.");
        });
    }
</script>
