<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="fw-bold"><i class="bi bi-speedometer2 text-danger"></i> Admin Console</h2>
            <p class="text-muted">Manage users and system settings</p>
        </div>
        <button class="btn btn-primary shadow-sm" onclick="openAddUserModal()">
            <i class="bi bi-plus-lg"></i> Add New User
        </button>
    </div>

    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white p-3 shadow-sm">
                <h3 id="statTotalUsers">-</h3>
                <p class="mb-0">Total Users</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white p-3 shadow-sm">
                <h3 id="statActiveListings">0</h3>
                <p class="mb-0">Active Listings</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-dark p-3 shadow-sm">
                <h3>12</h3>
                <p class="mb-0">Pending Reviews</p>
            </div>
        </div>
    </div>

    <div class="card shadow-sm border-0">
        <div class="card-header bg-white py-3">
            <h5 class="mb-0 fw-bold">System Users</h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="ps-4">User</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Date Joined</th>
                            <th class="text-end pe-4">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <tr><td colspan="5" class="text-center py-4 text-muted"><div class="spinner-border text-primary"></div> Loading users...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="card shadow-sm border-0 mt-4">
        <div class="card-header bg-white py-3">
            <h5 class="mb-0 fw-bold">Recent Property Listings</h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="ps-4">Property</th>
                            <th>Price</th>
                            <th>Beds</th>
                            <th>Baths</th>
                            <th>Area</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="propertiesTableBody">
                        <tr><td colspan="6" class="text-center py-4 text-muted">Loading properties...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="addUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addUserForm">
                    <div class="mb-3">
                        <label class="form-label">Full Name</label>
                        <input type="text" class="form-control" id="newUserName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" id="newUserEmail" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-control" id="newUserPass" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Role</label>
                        <select class="form-select" id="newUserRole">
                            <option value="buyer">Buyer</option>
                            <option value="agent">Agent</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                </form>
                <div id="addUserMessage" class="alert d-none"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitNewUser()">Create User</button>
            </div>
        </div>
    </div>
</div>

<script>
    function showAddUserMessage(message, isSuccess) {
        const el = document.getElementById('addUserMessage');
        if (!el) return;
        el.textContent = message;
        el.className = isSuccess ? 'alert alert-success' : 'alert alert-danger';
        el.classList.remove('d-none');
    }

    function isValidEmail(email) {
        return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    }

    fetchUsers();
    renderProperties();

     function fetchUsers() {
        window.UserService.getAll().then(function(result) {
            if (result.ok && Array.isArray(result.data)) {
                renderUsersTable(result.data);
                $('#statTotalUsers').text(result.data.length);
            } else {
                $('#usersTableBody').html('<tr><td colspan="5" class="text-center text-danger py-4">Error loading users.</td></tr>');
            }
        }).catch(function(err) {
            console.error("Fetch error:", err);
            $('#usersTableBody').html('<tr><td colspan="5" class="text-center text-danger py-4">Error loading users.</td></tr>');
        });
    }

    function renderUsersTable(users) {
        const tbody = $('#usersTableBody');
        tbody.empty();

        if(users.length === 0) {
            tbody.html('<tr><td colspan="5" class="text-center py-4">No users found in database.</td></tr>');
            return;
        }

        users.forEach(user => {
            let badgeClass = 'bg-secondary';
            if(user.role === 'admin') badgeClass = 'bg-danger';
            if(user.role === 'agent') badgeClass = 'bg-success';
            if(user.role === 'buyer' || user.role === 'user') badgeClass = 'bg-info text-dark';

            let name = user.full_name || user.name || 'Unknown';
            let initials = name.charAt(0).toUpperCase();
            let date = user.created_at ? user.created_at.split(' ')[0] : '-';

            const row = `
                <tr>
                    <td class="ps-4">
                        <div class="d-flex align-items-center">
                            <div class="bg-light rounded-circle me-2 d-flex justify-content-center align-items-center border fw-bold text-primary" style="width:35px;height:35px">
                                ${initials}
                            </div>
                            <div>
                                <div class="fw-bold">${name}</div>
                                <div class="small text-muted">${user.email}</div>
                            </div>
                        </div>
                    </td>
                    <td><span class="badge ${badgeClass} text-uppercase">${user.role}</span></td>
                    <td><span class="badge bg-success">Active</span></td>
                    <td>${date}</td>
                    <td class="text-end pe-4">
                        <button class="btn btn-sm btn-outline-secondary me-1"><i class="bi bi-pencil"></i></button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteUser(${user.id || user.user_id})"><i class="bi bi-trash"></i></button>
                    </td>
                </tr>
            `;
            tbody.append(row);
        });
    }

    let modal;
    function openAddUserModal() {
        $('#addUserForm')[0].reset();
        showAddUserMessage('', true);
        document.getElementById('addUserMessage').classList.add('d-none');
        modal = new bootstrap.Modal(document.getElementById('addUserModal'));
        modal.show();
    }

    function formatPrice(value) {
        if (typeof Intl !== 'undefined' && Intl.NumberFormat) {
            return new Intl.NumberFormat('en-GB').format(value) + ' EUR';
        }
        return value + ' EUR';
    }

    function renderProperties() {
        const tbody = document.getElementById('propertiesTableBody');
        if (!tbody || !window.ListingsService) return;
        const listings = window.ListingsService.getAll().slice(0, 6);

        if (!listings.length) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-muted">No properties available.</td></tr>';
            return;
        }

        tbody.innerHTML = listings.map(function(item) {
            return `
                <tr>
                    <td class="ps-4">
                        <div class="fw-bold">${item.title}</div>
                        <div class="small text-muted">${item.location}</div>
                    </td>
                    <td>${formatPrice(item.price)}</td>
                    <td>${item.beds}</td>
                    <td>${item.baths}</td>
                    <td>${item.area} m2</td>
                    <td><span class="badge bg-primary">${item.status}</span></td>
                </tr>
            `;
        }).join('');
    }

    function submitNewUser() {
        const userData = {
            name: $('#newUserName').val().trim(),
            email: $('#newUserEmail').val().trim(),
            password: $('#newUserPass').val(),
            role: $('#newUserRole').val()
        };

        if (!userData.name || !userData.email || !userData.password) {
            showAddUserMessage('All fields are required.', false);
            return;
        }
        if (!isValidEmail(userData.email)) {
            showAddUserMessage('Enter a valid email address.', false);
            return;
        }
        if (userData.password.length < 4) {
            showAddUserMessage('Password must be at least 4 characters.', false);
            return;
        }

        window.AuthService.register(userData).then(function(result) {
            if (result.ok) {
                showAddUserMessage('User created successfully!', true);
                if (modal) modal.hide();
                fetchUsers();
            } else {
                showAddUserMessage(result.data?.message || result.data?.error || 'Error creating user.', false);
            }
        }).catch(function(err) {
            console.error(err);
            showAddUserMessage('Error creating user.', false);
        });
    }

    function deleteUser(id) {
        if(confirm("Are you sure you want to delete this user?")) {
            window.UserService.delete(id).then(function(result) {
                if (result.ok) {
                    fetchUsers();
                } else {
                    alert("Error deleting user. Make sure you are Admin.");
                }
            }).catch(function() {
                alert("Error deleting user. Make sure you are Admin.");
            });
        }
    }
</script>
